/*******************************************************************************
* KindEditor - WYSIWYG HTML Editor for Internet
* Copyright (C) 2006-2011 kindsoft.net
*
* @author Roddy <luolonghao@gmail.com>
* @site http://www.kindsoft.net/
* @licence http://www.kindsoft.net/license.php
*******************************************************************************/

KindEditor.plugin("table",function(e){function s(e,t){t=t.toUpperCase(),e.css("background-color",t),e.css("color",t==="#000000"?"#FFFFFF":"#000000"),e.html(t)}function u(n,r){function i(){e.each(o,function(){this.remove()}),o=[],e(document).unbind("click,mousedown",i),n.unbind("click,mousedown",i)}r.bind("click,mousedown",function(e){e.stopPropagation()}),r.click(function(r){i();var u=e(this),a=u.pos(),f=e.colorpicker({x:a.x,y:a.y+u.height(),z:811214,selectedColor:e(this).html(),colors:t.colorTable,noColor:t.lang("noColor"),shadowMode:t.shadowMode,click:function(e){s(u,e),i()}});o.push(f),e(document).bind("click,mousedown",i),n.bind("click,mousedown",i)})}function a(e,t,n){var r=0;for(var i=0,s=t.cells.length;i<s;i++){if(t.cells[i]==n)break;r+=t.cells[i].rowSpan-1}return n.cellIndex-r}var t=this,n="table",r=t.lang(n+"."),i="ke-zeroborder",o=[];t.plugin.table={prop:function(o){var a=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keRows" style="width:90px;">'+r.cells+"</label>",r.rows+' <input type="text" id="keRows" class="ke-input-text ke-input-number" name="rows" value="" maxlength="4" /> &nbsp; ',r.cols+' <input type="text" class="ke-input-text ke-input-number" name="cols" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+r.size+"</label>",r.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+r.percent+"</option>",'<option value="px">'+r.px+"</option>","</select> &nbsp; ",r.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+r.percent+"</option>",'<option value="px">'+r.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="kePadding" style="width:90px;">'+r.space+"</label>",r.padding+' <input type="text" id="kePadding" class="ke-input-text ke-input-number" name="padding" value="" maxlength="4" /> &nbsp; ',r.spacing+' <input type="text" class="ke-input-text ke-input-number" name="spacing" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+r.align+"</label>",'<select id="keAlign" name="align">','<option value="">'+r.alignDefault+"</option>",'<option value="left">'+r.alignLeft+"</option>",'<option value="center">'+r.alignCenter+"</option>",'<option value="right">'+r.alignRight+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+r.border+"</label>",r.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',r.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+r.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),f=t.cmd.range.createBookmark(),l=t.createDialog({name:n,width:500,title:t.lang(n),body:a,beforeRemove:function(){S.unbind()},yesBtn:{name:t.lang("yes"),click:function(n){var r=h.val(),s=p.val(),o=d.val(),u=v.val(),a=m.val(),l=g.val(),c=y.val(),T=b.val(),N=w.val(),C=E.val(),k=e(S[0]).html()||"",L=e(S[1]).html()||"";if(r==0||!/^\d+$/.test(r)){alert(t.lang("invalidRows")),h[0].focus();return}if(s==0||!/^\d+$/.test(s)){alert(t.lang("invalidRows")),p[0].focus();return}if(!/^\d*$/.test(o)){alert(t.lang("invalidWidth")),d[0].focus();return}if(!/^\d*$/.test(u)){alert(t.lang("invalidHeight")),v[0].focus();return}if(!/^\d*$/.test(c)){alert(t.lang("invalidPadding")),y[0].focus();return}if(!/^\d*$/.test(T)){alert(t.lang("invalidSpacing")),b[0].focus();return}if(!/^\d*$/.test(C)){alert(t.lang("invalidBorder")),E[0].focus();return}if(x){o!==""?x.width(o+a):x.css("width",""),x[0].width!==undefined&&x.removeAttr("width"),u!==""?x.height(u+l):x.css("height",""),x[0].height!==undefined&&x.removeAttr("height"),x.css("background-color",L),x[0].bgColor!==undefined&&x.removeAttr("bgColor"),c!==""?x[0].cellPadding=c:x.removeAttr("cellPadding"),T!==""?x[0].cellSpacing=T:x.removeAttr("cellSpacing"),N!==""?x[0].align=N:x.removeAttr("align"),C!==""?x.attr("border",C):x.removeAttr("border"),C===""||C==="0"?x.addClass(i):x.removeClass(i),k!==""?x.attr("borderColor",k):x.removeAttr("borderColor"),t.hideDialog().focus(),t.cmd.range.moveToBookmark(f),t.cmd.select(),t.addBookmark();return}var A="";o!==""&&(A+="width:"+o+a+";"),u!==""&&(A+="height:"+u+l+";"),L!==""&&(A+="background-color:"+L+";");var O="<table";A!==""&&(O+=' style="'+A+'"'),c!==""&&(O+=' cellpadding="'+c+'"'),T!==""&&(O+=' cellspacing="'+T+'"'),N!==""&&(O+=' align="'+N+'"'),C!==""&&(O+=' border="'+C+'"');if(C===""||C==="0")O+=' class="'+i+'"';k!==""&&(O+=' bordercolor="'+k+'"'),O+=">";for(var M=0;M<r;M++){O+="<tr>";for(var _=0;_<s;_++)O+="<td>"+(e.IE?"&nbsp;":"<br />")+"</td>";O+="</tr>"}O+="</table>",e.IE||(O+="<br />"),t.insertHtml(O),t.select().hideDialog().focus(),t.addBookmark()}}}),c=l.div,h=e('[name="rows"]',c).val(3),p=e('[name="cols"]',c).val(2),d=e('[name="width"]',c).val(100),v=e('[name="height"]',c),m=e('[name="widthType"]',c),g=e('[name="heightType"]',c),y=e('[name="padding"]',c).val(2),b=e('[name="spacing"]',c).val(0),w=e('[name="align"]',c),E=e('[name="border"]',c).val(1),S=e(".ke-input-color",c);u(c,S.eq(0)),u(c,S.eq(1)),s(S.eq(0),"#000000"),s(S.eq(1),""),h[0].focus(),h[0].select();var x;if(o)return;x=t.plugin.getSelectedTable();if(x){h.val(x[0].rows.length),p.val(x[0].rows.length>0?x[0].rows[0].cells.length:0),h.attr("disabled",!0),p.attr("disabled",!0);var T,N=x[0].style.width||x[0].width,C=x[0].style.height||x[0].height;N!==undefined&&(T=/^(\d+)((?:px|%)*)$/.exec(N))?(d.val(T[1]),m.val(T[2])):d.val(""),C!==undefined&&(T=/^(\d+)((?:px|%)*)$/.exec(C))&&(v.val(T[1]),g.val(T[2])),y.val(x[0].cellPadding||""),b.val(x[0].cellSpacing||""),w.val(x[0].align||""),E.val(x[0].border===undefined?"":x[0].border),s(S.eq(0),e.toHex(x.attr("borderColor")||"")),s(S.eq(1),e.toHex(x[0].style.backgroundColor||x[0].bgColor||"")),d[0].focus(),d[0].select()}},cellprop:function(){var i=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+r.size+"</label>",r.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+r.percent+"</option>",'<option value="px">'+r.px+"</option>","</select> &nbsp; ",r.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+r.percent+"</option>",'<option value="px">'+r.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+r.align+"</label>",r.textAlign+' <select id="keAlign" name="textAlign">','<option value="">'+r.alignDefault+"</option>",'<option value="left">'+r.alignLeft+"</option>",'<option value="center">'+r.alignCenter+"</option>",'<option value="right">'+r.alignRight+"</option>","</select> ",r.verticalAlign+' <select name="verticalAlign">','<option value="">'+r.alignDefault+"</option>",'<option value="top">'+r.alignTop+"</option>",'<option value="middle">'+r.alignMiddle+"</option>",'<option value="bottom">'+r.alignBottom+"</option>",'<option value="baseline">'+r.alignBaseline+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+r.border+"</label>",r.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',r.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+r.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),o=t.cmd.range.createBookmark(),a=t.createDialog({name:n,width:500,title:t.lang("tablecell"),body:i,beforeRemove:function(){b.unbind()},yesBtn:{name:t.lang("yes"),click:function(n){var r=l.val(),i=c.val(),s=h.val(),u=p.val(),a=d.val(),f=v.val(),E=m.val(),S=g.val(),x=y.val(),T=e(b[0]).html()||"",N=e(b[1]).html()||"";if(!/^\d*$/.test(r)){alert(t.lang("invalidWidth")),l[0].focus();return}if(!/^\d*$/.test(i)){alert(t.lang("invalidHeight")),c[0].focus();return}if(!/^\d*$/.test(x)){alert(t.lang("invalidBorder")),y[0].focus();return}w.css({width:r!==""?r+s:"",height:i!==""?i+u:"","background-color":N,"text-align":E,"vertical-align":S,"border-width":x,"border-style":x!==""?"solid":"","border-color":T}),t.hideDialog().focus(),t.cmd.range.moveToBookmark(o),t.cmd.select(),t.addBookmark()}}}),f=a.div,l=e('[name="width"]',f).val(100),c=e('[name="height"]',f),h=e('[name="widthType"]',f),p=e('[name="heightType"]',f),d=e('[name="padding"]',f).val(2),v=e('[name="spacing"]',f).val(0),m=e('[name="textAlign"]',f),g=e('[name="verticalAlign"]',f),y=e('[name="border"]',f).val(1),b=e(".ke-input-color",f);u(f,b.eq(0)),u(f,b.eq(1)),s(b.eq(0),"#000000"),s(b.eq(1),""),l[0].focus(),l[0].select();var w=t.plugin.getSelectedCell(),E,S=w[0].style.width||w[0].width||"",x=w[0].style.height||w[0].height||"";(E=/^(\d+)((?:px|%)*)$/.exec(S))?(l.val(E[1]),h.val(E[2])):l.val("");if(E=/^(\d+)((?:px|%)*)$/.exec(x))c.val(E[1]),p.val(E[2]);m.val(w[0].style.textAlign||""),g.val(w[0].style.verticalAlign||"");var T=w[0].style.borderWidth||"";T&&(T=parseInt(T)),y.val(T),s(b.eq(0),e.toHex(w[0].style.borderColor||"")),s(b.eq(1),e.toHex(w[0].style.backgroundColor||"")),l[0].focus(),l[0].select()},insert:function(){this.prop(!0)},"delete":function(){var e=t.plugin.getSelectedTable();t.cmd.range.setStartBefore(e[0]).collapse(!0),t.cmd.select(),e.remove(),t.addBookmark()},colinsert:function(n){var r=t.plugin.getSelectedTable()[0],i=t.plugin.getSelectedRow()[0],s=t.plugin.getSelectedCell()[0],o=s.cellIndex+n;o+=r.rows[0].cells.length-i.cells.length;for(var u=0,f=r.rows.length;u<f;u++){var l=r.rows[u],c=l.insertCell(o);c.innerHTML=e.IE?"":"<br />",o=a(r,l,c)}t.cmd.range.selectNodeContents(s).collapse(!0),t.cmd.select(),t.addBookmark()},colinsertleft:function(){this.colinsert(0)},colinsertright:function(){this.colinsert(1)},rowinsert:function(n){var r=t.plugin.getSelectedTable()[0],i=t.plugin.getSelectedRow()[0],s=t.plugin.getSelectedCell()[0],o=i.rowIndex;n===1&&(o=i.rowIndex+(s.rowSpan-1)+n);var u=r.insertRow(o);for(var a=0,f=i.cells.length;a<f;a++){i.cells[a].rowSpan>1&&(f-=i.cells[a].rowSpan-1);var l=u.insertCell(a);n===1&&i.cells[a].colSpan>1&&(l.colSpan=i.cells[a].colSpan),l.innerHTML=e.IE?"":"<br />"}for(var c=o;c>=0;c--){var h=r.rows[c].cells;if(h.length>a){for(var p=s.cellIndex;p>=0;p--)h[p].rowSpan>1&&(h[p].rowSpan+=1);break}}t.cmd.range.selectNodeContents(s).collapse(!0),t.cmd.select(),t.addBookmark()},rowinsertabove:function(){this.rowinsert(0)},rowinsertbelow:function(){this.rowinsert(1)},rowmerge:function(){var e=t.plugin.getSelectedTable()[0],n=t.plugin.getSelectedRow()[0],r=t.plugin.getSelectedCell()[0],i=n.rowIndex,s=i+r.rowSpan,o=e.rows[s];if(e.rows.length<=s)return;var u=r.cellIndex;if(o.cells.length<=u)return;var a=o.cells[u];if(r.colSpan!==a.colSpan)return;r.rowSpan+=a.rowSpan,o.deleteCell(u),t.cmd.range.selectNodeContents(r).collapse(!0),t.cmd.select(),t.addBookmark()},colmerge:function(){var e=t.plugin.getSelectedTable()[0],n=t.plugin.getSelectedRow()[0],r=t.plugin.getSelectedCell()[0],i=n.rowIndex,s=r.cellIndex,o=s+1;if(n.cells.length<=o)return;var u=n.cells[o];if(r.rowSpan!==u.rowSpan)return;r.colSpan+=u.colSpan,n.deleteCell(o),t.cmd.range.selectNodeContents(r).collapse(!0),t.cmd.select(),t.addBookmark()},rowsplit:function(){var n=t.plugin.getSelectedTable()[0],r=t.plugin.getSelectedRow()[0],i=t.plugin.getSelectedCell()[0],s=r.rowIndex;if(i.rowSpan===1)return;var o=a(n,r,i);for(var u=1,f=i.rowSpan;u<f;u++){var l=n.rows[s+u],c=l.insertCell(o);i.colSpan>1&&(c.colSpan=i.colSpan),c.innerHTML=e.IE?"":"<br />",o=a(n,l,c)}e(i).removeAttr("rowSpan"),t.cmd.range.selectNodeContents(i).collapse(!0),t.cmd.select(),t.addBookmark()},colsplit:function(){var n=t.plugin.getSelectedTable()[0],r=t.plugin.getSelectedRow()[0],i=t.plugin.getSelectedCell()[0],s=i.cellIndex;if(i.colSpan===1)return;for(var o=1,u=i.colSpan;o<u;o++){var a=r.insertCell(s+o);i.rowSpan>1&&(a.rowSpan=i.rowSpan),a.innerHTML=e.IE?"":"<br />"}e(i).removeAttr("colSpan"),t.cmd.range.selectNodeContents(i).collapse(!0),t.cmd.select(),t.addBookmark()},coldelete:function(){var n=t.plugin.getSelectedTable()[0],r=t.plugin.getSelectedRow()[0],i=t.plugin.getSelectedCell()[0],s=i.cellIndex;for(var o=0,u=n.rows.length;o<u;o++){var a=n.rows[o],f=a.cells[s];f.colSpan>1?(f.colSpan-=1,f.colSpan===1&&e(f).removeAttr("colSpan")):a.deleteCell(s),f.rowSpan>1&&(o+=f.rowSpan-1)}r.cells.length===0?(t.cmd.range.setStartBefore(n).collapse(!0),t.cmd.select(),e(n).remove()):t.cmd.selection(!0),t.addBookmark()},rowdelete:function(){var n=t.plugin.getSelectedTable()[0],r=t.plugin.getSelectedRow()[0],i=t.plugin.getSelectedCell()[0],s=r.rowIndex;for(var o=i.rowSpan-1;o>=0;o--)n.deleteRow(s+o);n.rows.length===0?(t.cmd.range.setStartBefore(n).collapse(!0),t.cmd.select(),e(n).remove()):t.cmd.selection(!0),t.addBookmark()}},t.clickToolbar(n,t.plugin.table.prop)});