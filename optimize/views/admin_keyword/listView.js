define(["jquery","backbone","underscore","mustache","dialogPlus","stringUtil"],function(e,t,n,r,i,s){var o=t.View.extend({template:e("#tpl_keyword_list").html(),el:"#main",events:{"click .button_submit":"setKeyWordReturn","click .button_search":"search","click #keyword_types a.del":"delKeywordType","click #keyword_types a.edit":"editKeywordType","click #keywords a.del":"delKeyword","click #keywords a.edit":"editKeyword","click .edit_keyword":"submitEditKeyword","click .add_keyword":"addKeyword","click .add_keyword_type":"addKeywordType","click .edit_keyword_type":"submitEditKeywordType","change #ddlClass,#ddlModel,#ddlType":"render"},initialize:function(){this.topDialog=top.dialog?top.dialog.get(window):this.model.defaults,this.requestData=this.topDialog.data,this.ddlClass=this.$("#ddlClass"),this.ddlModel=this.$("#ddlModel"),this.ddlType=this.$("#ddlType"),n.bindAll(this,"render","renderWithoutDdl"),this.setSelected(),this.render()},render:function(){var t=this;return t.model.fetch({data:e.param(t.getSelectValues("getKeywords")),success:function(i,o){var u=o,a=r.to_html(t.template,u);t.$("dl").remove(),t.$el.append(a),t.setKeyWordReference();var f=u.DataList;e("#ddlParent option:not(:first)").remove(),e("#ddlKeywordType option:not(:first)").remove(),n.each(f,function(t){var n=s.format('<option value="{0}">{1}</option>',t.KeywordTypeId,t.Name);e("#ddlParent").append(n),e("#ddlKeywordType").append(n)})}}),t},renderWithoutDdl:function(){var t=this;return t.model.fetch({data:e.param(t.getSelectValues("getKeywords")),success:function(e,n){var i=n,s=r.to_html(t.template,i);t.$("dl").remove(),t.$el.append(s),t.setKeyWordReference()}}),t},setSelected:function(){e("#ddlClass option[value="+this.requestData.pclass+"]").attr("selected",!0),e("#ddlModel option[value="+this.requestData.pmodel+"]").attr("selected",!0),e("#ddlType option[value="+this.requestData.ptype+"]").attr("selected",!0)},setKeyWordReference:function(){var t=this.requestData.txt.split(",");n.each(t,function(t){e("#keywords dd input[type=checkbox]").each(function(){n.isEqual(e(this).val(),t)&&e(this).attr("checked",!0)})})},setKeyWordReturn:function(){var t=[];e("#keywords dd input[type=checkbox]").each(function(){e(this).is(":checked")&&t.push(e(this).val())});if(!n.isEmpty(t)){var r=this.getSelectValues();r=n.extend(r,{txt:","+t.join(",")+","}),this.topDialog.close(r)}else this.topDialog.close("");this.topDialog.remove()},search:function(){this.render()},getSelectValues:function(e){return{pmodel:this.ddlModel.val(),pclass:this.ddlClass.val(),ptype:this.ddlType.val(),random:Math.random(),operate:e||""}},delKeywordType:function(e){if(!confirm("您确定删除该关键字类别吗？"))return;var t={typeid:e.currentTarget.attributes.keyid.nodeValue};this.postKeyword({operate:"delKeywordType",otherData:t})},addKeywordType:function(t){var n=e(t.currentTarget).siblings("input[type=text]").val(),r=e("#ddlParent").val(),i={wtype:n,parentid:r,sort:0};this.postKeyword({operate:"addKeywordType",validate:!0,otherData:i})},editKeywordType:function(t){var n=t.currentTarget.attributes.keyid.nodeValue,r=t.currentTarget.attributes.parentid.nodeValue,i=t.currentTarget.previousSibling.nodeValue;e("#currentTypeId").val(n),e("#currentType").val(e.trim(i)),e("#ddlParent ").val(r)},submitEditKeywordType:function(){var t=e("#currentTypeId").val(),n=e("#currentType").val(),r=e("#ddlParent").val(),i={typeid:t,wtype:n,parentid:r,sort:0};this.postKeyword({operate:"editKeywordType",validate:!0,otherData:i})},delKeyword:function(e){if(!confirm("您确定删除该关键字吗？"))return;var t={wordid:e.currentTarget.attributes.wordid.nodeValue};this.postKeyword({operate:"delKeyword",otherData:t})},editKeyword:function(t){var n=t.currentTarget.attributes.wordid.nodeValue,r=t.currentTarget.attributes.keyid.nodeValue,i=t.currentTarget.previousSibling.nodeValue;e("#currentWordId").val(n),e("#currentWord").val(e.trim(i)),e("#ddlKeywordType").val(r)},submitEditKeyword:function(){var t=e("#currentWordId").val(),n=e("#currentWord").val(),r=e("#ddlKeywordType").val(),i={wordid:t,word:n,typeid:r};this.postKeyword({operate:"editKeyword",validate:!0,otherData:i})},addKeyword:function(t){var n=e("#ddlKeywordType").val(),r={word:e(t.currentTarget).siblings("input[type=text]").val(),typeid:n};this.postKeyword({operate:"addKeyword",validate:!0,otherData:r})},postKeyword:function(t){var r=this,i=this.getSelectValues(t.operate);n.isEmpty(t.otherData)||n.extend(i,t.otherData);if(t.validate){var s=this.model.validate(i);if(n.isString(s)){this.showDialog({content:s});return}}e.post(r.model.url,i,function(e){r.showDialog({content:e.Msg}),r.renderWithoutDdl()},"json")},showDialog:function(e){var t={quickClose:!0};n.extend(t,e),t.title=e.title||"信息提示",t.width=e.width||140,i(t).show()}});return o});